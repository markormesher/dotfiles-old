#!/usr/bin/env bash

volume="$1"

echo "Trying to backup $volume..."

# check whether volume exists
doesExist=$(/usr/bin/docker volume ls -f "name=$volume" --format "{{ .Name }}" | grep "^$volume\$" | wc -l)
if [ ! $doesExist = 1 ]; then
	echo "ERROR: Volume $volume does not exist"
	exit 1
fi

# check whether volume is in use
inUse=$(/usr/bin/docker ps -f "volume=$volume" --format "{{ .Names }}" | wc -l)
if [ ! $inUse = 0 ]; then
	echo "ERROR: Volume is connected to $inUse running container(s):"
	/usr/bin/docker ps -f "volume=$volume" --format "{{ .Names }}"
	exit 1
fi

# do the backup
filename=volumebackup$(date +%s).tar
touch /tmp/$filename
/usr/bin/docker run -v $volume:/volume -v /tmp:/backup alpine tar -cf /backup/$filename -C /volume ./ > /dev/null
cat /tmp/$filename
rm /tmp/$filename
