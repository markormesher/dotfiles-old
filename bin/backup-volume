#! /usr/bin/env bash

volume="$1"

# check whether volume exists
doesExist=$(docker volume ls -f "name=$volume" --format "{{ .Name }}" | grep "^$volume\$" | wc -l)
if [ ! $doesExist = 1 ]; then
	echo "ERROR: Volume $volume does not exist"
	exit 1
fi

# check whether volume is in use
inUse=$(docker ps -f "volume=$volume" --format "{{ .Names }}" | wc -l)
if [ ! $inUse = 0 ]; then
	echo "ERROR: Volume is connected to $inUse running container(s):"
	docker ps -f "volume=$volume" --format "{{ .Names }}"
	exit 1
fi

# do the backup
docker run -it -v $volume:/volume -v /tmp:/backup alpine tar -czf - -C /volume ./
echo "/tmp/$volume.tgz"
